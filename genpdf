#!/usr/bin/env bash
# Script name and description
# genpdf - Generate PDF files from Jupyter notebooks

# Script usage and dependencies
# This script converts notebook files to PDF format. It can process
# all notebooks in the specified project directory. The specified directory must be
# a Quarto project i.e., it must have a _quarto.yml file that specifies how to
# generate the pdf files.

# Usage:
#   genpdf <dir> - Convert all found ipynb files in directory to PDF

# Dependencies:
# quarto
# tee
# find

# Function to check if required dependencies are installed
require() {
  hash "$@" || exit 127
}

# Function to print usage
usage() {
  echo "usage: ${0} <dir1> ... <dirn>"
  echo "dir<1-n> - Quarto project directory"
  exit 1
}

# Check is required dependencies are met
require find quarto tee

# Check if any directories are provided as arguments
if [ $# -eq 0 ]; then
  usage
fi

# Remove any existing output file
rm -f genpdf.out || {
  echo "File permissions problem"
  exit 1
}

# Initialize exit code
declare -i exitcode=0

# Iterate over each provided directory
for proj in "$@"; do
  echo "Processing $proj..."
  # Check if the directory is a quarto project
  if [ ! -f "$proj/_quarto.yml" ]; then
    # Display error message and set exit code if not a quarto project
    echo "Error: $proj is not a Quarto project (missing _quarto.yml)"
    exitcode=$((exitcode + 1))
    continue
  fi
  # Convert ipynb files to quarto markdown files
  find "$proj" -maxdepth 1 -name "*.ipynb" -type f -exec quarto convert {} \;
  # Render the quarto project and redirect output to log file
  quarto render "$proj" --to pdf 2>&1 | tee -a genpdf.out
  # update exit code
  exitcode=$(("$exitcode" + $?))
done

# Display error message and exit
if [ "$exitcode" -gt 0 ]; then
  echo "Errors generating pdf files. Check genpdf.out for errors."
fi
exit "$exitcode"
